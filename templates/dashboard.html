<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Ortho_Psy Tech</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        :root {
            --brand-bg: #2c3e50;
            --gold: #f1c40f;
            --accent-blue: #3498db;
            --bg-gray: #f4f7f6;
            --white: #ffffff;
            --danger: #e74c3c;
            --success: #27ae60;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-gray); margin: 0; }

        /* ğŸ” Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-navbar {
            background: var(--brand-bg);
            color: white;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 65px;
            z-index: 1100;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
        }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .menu-toggle { font-size: 28px; cursor: pointer; color: var(--gold); }
        .brand-name { font-weight: bold; font-size: 1.3rem; }
        
        .nav-left { display: flex; align-items: center; gap: 10px; }
        .btn-logout { 
            background: var(--danger); 
            color: white; 
            text-decoration: none; 
            padding: 8px 18px; 
            border-radius: 8px; 
            font-size: 0.9rem; 
            font-weight: bold;
            transition: 0.3s;
        }
        .btn-logout:hover { background: #c0392b; }

        /* Sidebar Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .admin-sidebar { 
            width: 260px; 
            background: var(--brand-bg); 
            height: 100vh; 
            color: white; 
            padding: 20px; 
            position: fixed; 
            right: -260px; /* Ù…Ø®ÙÙŠ */
            top: 0; 
            z-index: 1050; 
            transition: 0.4s;
            padding-top: 80px;
        }
        .admin-sidebar.active { right: 0; }
        
        .menu-item { 
            padding: 15px; 
            cursor: pointer; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            transition: 0.3s; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: rgba(255,255,255,0.05);
            text-decoration: none;
            color: white;
        }
        .menu-item:hover { background: var(--accent-blue); }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content { 
            padding: 95px 30px 30px 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .header-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-right: 5px solid var(--gold); }
        .stat-card h4 { margin: 0; color: #666; font-size: 0.9rem; }
        .stat-card p { margin: 10px 0 0; font-size: 2rem; font-weight: bold; color: var(--brand-bg); }
        
        .control-panel { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-container { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th { background: #f8f9fa; color: var(--brand-bg); padding: 15px; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 1rem; }

        /* Ø§Ù„Ù…Ø­Ø±Ø± */
        #editor-wrapper { margin-top: 20px; border-radius: 12px; overflow: hidden; border: 1px solid #ddd; }
        #editor-container { height: 350px; background: white; }
        .update-btn { background: var(--brand-bg); color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; margin-top: 15px; width: 100%; font-weight: bold; font-size: 1.1rem; }
        
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; z-index: 1040;
        }
        .sidebar-overlay.active { display: block; }
    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <nav class="top-navbar">
        <div class="nav-right">
            <span class="menu-toggle" onclick="toggleSidebar()">â˜°</span>
            <span class="brand-name">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
        </div>
        <div class="nav-left">
            <a href="/" class="btn-logout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </div>
    </nav>

    <div class="admin-sidebar" id="sidebar">
        <a href="/dashboard" class="menu-item">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a href="#" class="menu-item" onclick="toggleSidebar()">ğŸ“… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ({{ bookings|length }})</a>
        <a href="#" class="menu-item" onclick="toggleSidebar()">ğŸ‘¥ Ø§Ù„Ù…ÙØ­ÙˆØµÙŠÙ† ({{ examinees|length }})</a>
    </div>

    <div class="main-content">
        <div class="header-stats">
            <div class="stat-card"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h4><p>{{ bookings|length }}</p></div>
            <div class="stat-card" style="border-right-color: var(--success);"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙØ­ÙˆØµÙŠÙ†</h4><p>{{ examinees|length }}</p></div>
        </div>

        <div class="control-panel">
            <h3>ğŸ“… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø¯ÙŠØ«Ø§Ù‹</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for b in bookings %}
                        <tr>
                            <td>{{ b.date_submitted }}</td>
                            <td>{{ b.main_name }}</td>
                            <td>{{ b.phone }}</td>
                            <td>
                                <button onclick="alert('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: \n {{ b.problem }}')" style="background:var(--accent-blue); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Ø¹Ø±Ø¶</button>
                                <button onclick="convert('{{ b.id }}')" style="background:var(--success); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">ØªØ­ÙˆÙŠÙ„</button>
                                <button onclick="deleteItem('booking', '{{ b.id }}')" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Ø­Ø°Ù</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="control-panel" style="border-top: 4px solid var(--success);">
            <h3>ğŸ‘¥ Ø³Ø¬Ù„ Ø§Ù„Ù…ÙØ­ÙˆØµÙŠÙ† (Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒÙ„ÙŠÙ†ÙŠÙƒÙŠØ©)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ÙˆÙŠÙ„</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙØ­ÙˆØµ</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in examinees %}
                        <tr>
                            <td>{{ e.converted_at }}</td>
                            <td><strong>{{ e.main_name }}</strong></td>
                            <td>#{{ e.id[-5:] }}</td>
                            <td>
                                <a href="/examinee_file/{{ e.id }}" style="background:var(--brand-bg); color:white; text-decoration:none; padding:6px 12px; border-radius:5px; font-size:0.9rem; display:inline-block;">ğŸ“‚ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¥ÙƒÙ„ÙŠÙ†ÙŠÙƒÙŠ</a>
                                <a href="/follow_up/{{ e.id }}" style="background:#28a745; color:white; text-decoration:none; padding:6px 12px; border-radius:5px; font-size:0.9rem; display:inline-block; margin-right:5px;">ğŸ“ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ</a>
                                <button onclick="deleteItem('examinee', '{{ e.id }}')" style="background:var(--danger); color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer; margin-right:5px;">Ø­Ø°Ù</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="control-panel">
            <h3>ğŸ“¢ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯ (ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØ±Ø©)</h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border: 2px dashed #ccc; border-radius: 8px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px;">1. Ø§Ø®ØªØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ (Max 20MB):</label>
                <input type="file" id="mediaFile" accept="image/*,video/*" style="width: 100%;">
            </div>

            <label style="font-weight: bold; display: block; margin-bottom: 10px;">2. Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ/Ø§Ù„ØµÙˆØ±Ø©:</label>
            <div id="editor-wrapper" style="background: white;">
                <div id="editor-container" style="height: 150px;"></div>
            </div>

            <button class="update-btn" onclick="uploadSlide()" style="margin-top: 20px; width: 100%;">
                Ø±ÙØ¹ ÙˆÙ†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶ (ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØ±Ø© + Ù†Øµ) ğŸš€
            </button>

            <hr style="margin: 30px 0; border-top: 2px dashed #ddd;">
            
            <h3>ğŸï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© ({{ slides|length }})</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</th>
                            <th>Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±ÙÙ‚</th>
                            <th>Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for slide in slides %}
                        <tr>
                            <td style="width: 150px;">
                                {% if slide.image.endswith(('.mp4', '.mov', '.webm')) %}
                                    <video src="{{ slide.image }}" style="width: 100px; height: 60px; object-fit: cover; border-radius: 5px;"></video>
                                {% else %}
                                    <img src="{{ slide.image }}" style="width: 100px; height: 60px; object-fit: cover; border-radius: 5px;">
                                {% endif %}
                            </td>
                            <td>{{ slide.text | striptags | truncate(50) }}</td>
                            <td>
                                <button onclick="deleteSlide('{{ slide.id }}')" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Ø­Ø°Ù ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            </div>

    </div> <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <script>
        // --- 1. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // --- 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ø±Ø± ---
        var quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'color': [] }], [{ 'align': [] }], [{ 'direction': 'rtl' }]] }
        });

        // --- 3. Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ (ÙÙŠØ¯ÙŠÙˆ ÙˆØµÙˆØ±) ---
        function uploadSlide() {
            let fileInput = document.getElementById('mediaFile');
            let file = fileInput.files[0];
            
            if (!file) {
                alert("âš ï¸ Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }

            if (file.size > 20 * 1024 * 1024) { // 20 Ù…ÙŠØºØ§
                alert("âš ï¸ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹! ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 20 Ù…ÙŠØºØ§.");
                return;
            }

            let fd = new FormData();
            fd.append('media_file', file);
            fd.append('content', quill.root.innerHTML);

            let btn = document.querySelector('.update-btn');
            btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... â³";
            btn.disabled = true;

            fetch('/add_slide', { method: 'POST', body: fd })
            .then(response => {
                if (response.ok) {
                    alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
                    window.location.reload();
                } else {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹ âŒ");
                    btn.textContent = "Ø±ÙØ¹ ÙˆÙ†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶ ğŸš€";
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
                btn.textContent = "Ø±ÙØ¹ ÙˆÙ†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶ ğŸš€";
                btn.disabled = false;
            });
        }

        // --- 4. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„) ---
        function convert(id) { 
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­ÙˆÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ­ÙˆØµÙŠÙ†ØŸ')) { 
                fetch('/convert_to_examinee/' + id, { method: 'POST' }) 
                .then(r => r.ok ? location.reload() : alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„")); 
            } 
        } 

        function deleteItem(type, id) { 
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ')) { 
                let url = type === 'booking' ? '/delete_booking/' + id : '/delete_examinee/' + id; 
                fetch(url, { method: 'POST' }) 
                .then(r => r.ok ? location.reload() : alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù")); 
            } 
        }

        // âœ… ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ù„Ø³Ù„Ø§ÙŠØ¯)
        function deleteSlide(id) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±ØŸ')) {
                fetch('/delete_slide/' + id, { method: 'POST' })
                .then(r => r.ok ? location.reload() : alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù"));
            }
        }
    </script>
</body>
    </html>
